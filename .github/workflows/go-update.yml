name: Update Go Version

on:
  schedule:
    - cron: '0 9 * * 1' # Monday 09:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-go:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get latest stable Go version
        id: latest
        run: |
          LATEST=$(curl -sS 'https://go.dev/dl/?mode=json' | jq -r '.[0].version' | sed 's/^go//')
          echo "version=${LATEST}" >> "$GITHUB_OUTPUT"
          echo "Latest stable Go: ${LATEST}"

      - name: Get current Go version
        id: current
        run: |
          CURRENT=$(sed -n 's/^go //p' go.mod)
          echo "version=${CURRENT}" >> "$GITHUB_OUTPUT"
          echo "Current go.mod Go: ${CURRENT}"

      - name: Check if update needed
        id: check
        run: |
          if [ "${{ steps.latest.outputs.version }}" = "${{ steps.current.outputs.version }}" ]; then
            echo "needed=false" >> "$GITHUB_OUTPUT"
            echo "Already up to date."
          else
            echo "needed=true" >> "$GITHUB_OUTPUT"
            echo "Update available: ${{ steps.current.outputs.version }} -> ${{ steps.latest.outputs.version }}"
          fi

      - name: Set up Go
        if: steps.check.outputs.needed == 'true'
        uses: actions/setup-go@v6
        with:
          go-version: ${{ steps.latest.outputs.version }}

      - name: Update go.mod
        if: steps.check.outputs.needed == 'true'
        run: |
          go mod edit -go=${{ steps.latest.outputs.version }}
          go mod tidy

      - name: Create pull request
        if: steps.check.outputs.needed == 'true'
        run: |
          BRANCH="go-update/${{ steps.latest.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "${BRANCH}"
          git add go.mod go.sum
          git commit -m "Update Go to ${{ steps.latest.outputs.version }}"
          git push -u origin "${BRANCH}"
          gh pr create \
            --title "Update Go to ${{ steps.latest.outputs.version }}" \
            --body "$(cat <<'EOF'
          ## Summary
          - Bumps Go version from ${{ steps.current.outputs.version }} to ${{ steps.latest.outputs.version }}
          - Ran `go mod tidy` to update go.sum

          Auto-generated by the Go version update workflow.
          EOF
          )"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
